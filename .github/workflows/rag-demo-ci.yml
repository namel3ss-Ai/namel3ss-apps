name: rag-demo-ci

on:
  pull_request:
    paths:
      - 'apps/rag-demo/**'
      - 'docs/**'
      - 'invariants/**'
      - '.github/workflows/rag-demo-ci.yml'
  push:
    branches:
      - main
    paths:
      - 'apps/rag-demo/**'
      - 'docs/**'
      - 'invariants/**'
      - '.github/workflows/rag-demo-ci.yml'

jobs:
  verify:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.14'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install "git+https://github.com/namel3ss-Ai/namel3ss.git@d29f55522d7a3a6cebe9f99b4ba304a8d2aea446" pytest

      - name: Ensure provider pack manifests
        run: python apps/rag-demo/tools/ensure_provider_manifests.py

      - name: Validate app manifests
        run: |
          n3 check apps/rag-demo/app.ai
          n3 check apps/rag-application/app.ai

      - name: Run deterministic smoke regression
        run: |
          set -euo pipefail
          export N3_IDENTITY_ID=rag-demo-ci

          n3 apps/rag-demo/app.ai ui > /tmp/rag-manifest.json
          n3 apps/rag-demo/app.ai ui > /tmp/rag-manifest-second.json

          jq '{
            page_slug: .pages[0].slug,
            layout_slots: (.pages[0].layout | keys | sort),
            action_count: (.actions | length),
            upload_request: .upload_requests[0],
            theme_name: .theme.theme_name
          }' /tmp/rag-manifest.json > /tmp/rag-manifest-summary.json

          jq '{
            page_slug: .pages[0].slug,
            layout_slots: (.pages[0].layout | keys | sort),
            action_count: (.actions | length),
            upload_request: .upload_requests[0],
            theme_name: .theme.theme_name
          }' /tmp/rag-manifest-second.json > /tmp/rag-manifest-second-summary.json

          diff -u /tmp/rag-manifest-summary.json /tmp/rag-manifest-second-summary.json

          composer_action_id="$(jq -r '.actions | to_entries | map(select(.value.type=="call_flow" and .value.flow=="rag_engine.ask_question")) | .[0].key // empty' /tmp/rag-manifest.json)"
          guided_action_id="$(jq -r '.actions | to_entries | map(select(.value.type=="call_flow" and .value.flow=="rag_engine.run_demo_mode_path")) | .[0].key // empty' /tmp/rag-manifest.json)"
          citation_open_action_id="$(jq -r '.actions | to_entries | map(select(.value.type=="call_flow" and .value.flow=="rag_engine.open_citation" and (.key | contains("open_in_source_drawer")))) | if length > 0 then .[0].key else empty end' /tmp/rag-manifest.json)"
          if [[ -z "$citation_open_action_id" ]]; then
            citation_open_action_id="$(jq -r '.actions | to_entries | map(select(.value.type=="call_flow" and .value.flow=="rag_engine.open_citation")) | .[0].key // empty' /tmp/rag-manifest.json)"
          fi
          if [[ -z "$composer_action_id" || -z "$guided_action_id" || -z "$citation_open_action_id" ]]; then
            echo "Required action ids could not be resolved from manifest." >&2
            exit 1
          fi

          n3 apps/rag-demo/app.ai "$composer_action_id" --json '{"message":"what is this doc about"}' | jq '{
            mode: .result.mode,
            answer: .result.answer_text,
            citations: (.state.answer.citations // [] | map({
              index: .index,
              source_id: .source_id,
              chunk_id: .chunk_id,
              page_number: .page_number
            })),
            trusted: .state.answer.trusted,
            trust_score: .state.answer.trust_score,
            source_count: .state.answer.source_count
          }' > /tmp/rag-composer.json

          n3 apps/rag-demo/app.ai "$composer_action_id" --json '{"message":"what is this doc about"}' | jq '{
            mode: .result.mode,
            answer: .result.answer_text,
            citations: (.state.answer.citations // [] | map({
              index: .index,
              source_id: .source_id,
              chunk_id: .chunk_id,
              page_number: .page_number
            })),
            trusted: .state.answer.trusted,
            trust_score: .state.answer.trust_score,
            source_count: .state.answer.source_count
          }' > /tmp/rag-composer-second.json
          diff -u /tmp/rag-composer.json /tmp/rag-composer-second.json

          n3 apps/rag-demo/app.ai "$guided_action_id" --json '{}' | jq '{
            status: .result.status,
            mode: .result.mode,
            answer: .result.answer_text,
            citation_count: (.state.answer.citations | length),
            trusted: .state.answer.trusted,
            trust_score: .state.answer.trust_score,
            source_count: .state.answer.source_count,
            selected_source: .state.selected_citation_source,
            ready_documents: .state.ready_documents,
            total_documents: .state.total_documents,
            chunk_count: .state.chunk_count,
            tag_product_count: .state.tag_product_count
          }' > /tmp/rag-guided.json

          n3 apps/rag-demo/app.ai "$guided_action_id" --json '{}' | jq '{
            status: .result.status,
            mode: .result.mode,
            answer: .result.answer_text,
            citation_count: (.state.answer.citations | length),
            trusted: .state.answer.trusted,
            trust_score: .state.answer.trust_score,
            source_count: .state.answer.source_count,
            selected_source: .state.selected_citation_source,
            ready_documents: .state.ready_documents,
            total_documents: .state.total_documents,
            chunk_count: .state.chunk_count,
            tag_product_count: .state.tag_product_count
          }' > /tmp/rag-guided-second.json
          diff -u /tmp/rag-guided.json /tmp/rag-guided-second.json

          n3 apps/rag-demo/app.ai "$citation_open_action_id" --json '{"row":{"source_id":"guided-product","chunk_id":"guided-product-1","page_number":1}}' | jq '{
            result: .result,
            selected_source: .state.selected_citation_source,
            drawer: .state.drawer.has_selection
          }' > /tmp/rag-citation-open.json
          jq -e '.result == "ok" and .drawer == true' /tmp/rag-citation-open.json > /dev/null

      - name: Run pytest regression suite (if present)
        run: |
          set -euo pipefail
          if [[ -d apps/rag-demo/tests ]] && find apps/rag-demo/tests -type f -name 'test_*.py' | grep -q .; then
            python -m pytest -q apps/rag-demo/tests
          else
            echo "No rag-demo pytest files found; skipping."
          fi

      - name: Reproduce locally (on failure)
        if: failure()
        run: |
          echo "Reproduce with:"
          echo "  python apps/rag-demo/tools/ensure_provider_manifests.py"
          echo "  n3 check apps/rag-demo/app.ai"
          echo "  n3 check apps/rag-application/app.ai"
          echo "  n3 apps/rag-demo/app.ai ui > /tmp/rag-manifest.json"
          echo "  n3 apps/rag-demo/app.ai ui > /tmp/rag-manifest-second.json"
          echo "  diff -u /tmp/rag-manifest.json /tmp/rag-manifest-second.json"
          echo "  python -m pytest -q apps/rag-demo/tests  # if tests exist"
