spec is "1.0"

capabilities:
  uploads
  http
  `ui`.theming
  streaming
  ui_navigation
  ui_state

ui_state:
  session:
    preview_source is text
    citation_highlight_color is text
    active_project_id is text

ui:
  preset is "clarity"
  theme is "light"
  accent color is "blue"
  density is "comfortable"
  motion is "none"
  shape is "soft"
  surface is "flat"
  primary color is "#0A66C2"
  secondary color is "#E6ECF5"
  background color is "#FAFBFD"
  foreground color is "#111827"
  font family is "IBM Plex Sans, Segoe UI, sans-serif"
  spacing scale is 1.0
  border radius is 6
  shadow level is 0

policy
  allow ingestion.run
  allow ingestion.review
  allow ingestion.override
  allow retrieval.include_warn

use "rag_engine" as rag_engine

contract flow "rag_engine.initialize_defaults":
  input:
  output:
    status is text

contract flow "rag_engine.seed_examples":
  input:
  output:
    status is text

contract flow "rag_engine.ensure_projects":
  input:
  output:
    status is text

contract flow "rag_engine.create_project":
  input:
  output:
    status is text

contract flow "rag_engine.duplicate_project":
  input:
    project_id is text
  output:
    status is text

contract flow "rag_engine.share_project":
  input:
    project_id is text
  output:
    status is text

contract flow "rag_engine.archive_project":
  input:
    project_id is text
  output:
    status is text

contract flow "rag_engine.rename_active_project":
  input:
    project_name is text
  output:
    status is text

contract flow "rag_engine.delete_project":
  input:
    project_id is text
  output:
    status is text

contract flow "rag_engine.set_active_project":
  input:
    project_id is text
  output:
    status is text

contract flow "rag_engine.refresh_project_stats":
  input:
  output:
    status is text

contract flow "rag_engine.refresh_index_summary":
  input:
  output:
    status is text

contract flow "rag_engine.seed_sample_corpus":
  input:
  output:
    status is text

contract flow "rag_engine.sync_library":
  input:
  output:
    status is text

contract flow "rag_engine.ingest_web_source":
  input:
    web_url is text
  output:
    status is text

contract flow "rag_engine.bulk_select_all":
  input:
  output:
    status is text

contract flow "rag_engine.ingest_selected":
  input:
  output:
    status is text

contract flow "rag_engine.rename_document":
  input:
    upload_id is text
    source_name is text
  output:
    status is text

contract flow "rag_engine.add_document_to_project":
  input:
    upload_id is text
    project_id is text
  output:
    status is text

contract flow "rag_engine.remove_document_from_project":
  input:
    upload_id is text
    project_id is text
  output:
    status is text

contract flow "rag_engine.move_document_to_project":
  input:
    upload_id is text
    project_id is text
  output:
    status is text

contract flow "rag_engine.rerun_last_query":
  input:
  output:
    status is text

contract flow "rag_engine.refresh_diagnostics_view":
  input:
  output:
    status is text

contract flow "rag_engine.set_semantic_k":
  input:
    value is number
  output:
    status is text

contract flow "rag_engine.set_lexical_k":
  input:
    value is number
  output:
    status is text

contract flow "rag_engine.set_final_top_k":
  input:
    value is number
  output:
    status is text

contract flow "rag_engine.finalize_answer_state":
  input:
  output:
    status is text

contract flow "rag_engine.reset_chat":
  input:
  output:
    status is text

contract flow "rag_engine.ask_question":
  input:
    message is text
    query_text is text
    project_scope is text
    project_scope_label is text
    project_scope_conflict is boolean
    document_scope is json
    document_scope_mode is text
  output:
    answer_text is text
    mode is text

page "Chat":
  layout:
    sidebar_width is "wide"
    panel_height is "full"
    resizable_panels is false
    header:
      title is "RAG Workspace"
      text is "Project-scoped knowledge and grounded answers."

    sidebar_left:
      section "Projects":
        list is rag_engine.Project:
          variant is "icon_plain"
          item:
            primary is name
            secondary is status_label
            icon is icon
          empty_state: hidden
          actions:
            action "Open":
              calls flow "rag_engine.set_active_project"
            action "Rename":
              calls flow "rag_engine.rename_active_project"
              interaction is rename_modal
            action "Duplicate":
              calls flow "rag_engine.duplicate_project"
            action "Share":
              calls flow "rag_engine.share_project"
            action "Archive":
              calls flow "rag_engine.archive_project"
            action "Delete project":
              calls flow "rag_engine.delete_project"
              interaction is confirm_destructive

        button "Create project":
          icon is folder_add
          variant is "primary"
          calls flow "rag_engine.create_project"

      section "Question Files":
        upload question_files:
          accept is "application/pdf,text/plain"
          multiple is true
          required is false
          label is "Attach files for this question"
          preview is false

    main:
      section "Assistant":
        row:
          column:
            button "Create chat":
              icon is chat_add_on
              variant is "secondary"
              calls flow "rag_engine.reset_chat"

        chat:
          style is "bubbles"
          show_avatars is false
          group_messages is true
          actions are ["copy", "expand"]
          attachments are true
          streaming is false
          composer_placeholder is "Ask a grounded question about this project..."
          composer_send_style is icon
          composer_attach_upload is "question_files"
          messages from is state.chat.messages
          composer calls flow "rag_engine.ask_question"

      section "Project Intake":
        upload project_files:
          accept is "application/pdf,text/plain"
          multiple is true
          required is false
          label is "Upload files"
          preview is false

        row:
          column:
            button "Create project index":
              variant is "primary"
              calls flow "rag_engine.ingest_selected"
          column:
            button "View file status":
              icon is refresh
              variant is "secondary"
              calls flow "rag_engine.sync_library"

        input text as web_url
          send to flow "rag_engine.ingest_web_source"

      section "Project Files":
        list is rag_engine.ProjectKnowledgeItem:
          variant is "two_line"
          item:
            primary is source_name
            secondary is status_label
            meta is scope_label
          empty_state: hidden
          actions:
            action "Rename file":
              calls flow "rag_engine.rename_document"
              interaction is rename_modal
            action "Move to project...":
              calls flow "rag_engine.move_document_to_project"
              interaction is project_picker
            action "Remove from project":
              calls flow "rag_engine.remove_document_from_project"
            action "Delete file":
              calls flow "rag_engine.remove_document"
              interaction is confirm_destructive

    drawer_right:
      section "Source Evidence":
        list is rag_engine.CitationCard:
          variant is "two_line"
          item:
            primary is source_name
            secondary is page_label
            meta is snippet
          empty_state: hidden
          actions:
            action "Open in source drawer":
              calls flow "rag_engine.open_citation"
            action "Rename file":
              calls flow "rag_engine.rename_document"
              interaction is rename_modal
            action "Move to project...":
              calls flow "rag_engine.move_document_to_project"
              interaction is project_picker
            action "Delete file":
              calls flow "rag_engine.remove_document"
              interaction is confirm_destructive

page "Library":
  debug_only: true
  layout:
    header:
      title is "Documents"
      text is "Upload content, run deterministic ingestion, and choose scope."
      row:
        column:
          section "Status":
            list is rag_engine.Notice:
              variant is "single_line"
              item:
                primary is message
              empty_state: hidden
        column:
          section "Run Target":
            text is "Repo-root check: n3 check apps/rag-demo/app.ai"
            text is "Repo-root run: n3 run apps/rag-demo/app.ai --port 7360 --no-open"
            text is "Renderer health: curl -sS http://127.0.0.1:7360/api/renderer-registry/health | jq ."

    main:
      section "Upload and Index":
        text is "Supported types: application/pdf and text/plain."
        text is "Ingestion states: queued -> ingesting -> ready."
        upload documents:
          accept is "application/pdf,text/plain"
          multiple is true
          required is false
          label is "Upload documents"
          preview is false

        row:
          column:
            button "View Uploads":
              variant is "secondary"
              calls flow "rag_engine.sync_library"
          column:
            button "Create Index":
              variant is "primary"
              calls flow "rag_engine.ingest_selected"

        row:
          column:
            button "Run guided path":
              variant is "secondary"
              calls flow "rag_engine.run_demo_mode_path"
          column:
            button "Create sample corpus":
              variant is "secondary"
              calls flow "rag_engine.seed_sample_corpus"

      section "Index Summary":
        table is rag_engine.IndexSummary:
          columns:
            include total_documents
            include ready_documents
            include queued_documents
            include ingesting_documents
            include failed_documents
            include chunk_count
            include tag_product_count
            include tag_policy_count
          empty_state: hidden

      section "Scope":
        text is "Select which sources and tags are active during retrieval."
        scope_selector from is state.tag.options active in state.tag.active

        row:
          column:
            button "View All Sources":
              variant is "secondary"
              calls flow "rag_engine.bulk_select_all"
          column:
            button "Reset Selected Sources":
              variant is "secondary"
              calls flow "rag_engine.bulk_clear_selection"

        row:
          column:
            button "Create Reindex Queue":
              variant is "secondary"
              calls flow "rag_engine.bulk_reindex_selected"
          column:
            button "Remove selected sources":
              variant is "secondary"
              calls flow "rag_engine.bulk_remove_selected"

        row:
          column:
            button "Create Product Tags":
              variant is "secondary"
              calls flow "rag_engine.bulk_tag_selected_product"
          column:
            button "Create Policy Tags":
              variant is "secondary"
              calls flow "rag_engine.bulk_tag_selected_policy"

        list is rag_engine.DocumentLibrary:
          variant is "two_line"
          selection is "multi"
          item:
            primary is source_name
            secondary is status_label
            meta is scope_label
          actions:
            action "Add to scope":
              calls flow "rag_engine.add_document_selection"
            action "Remove from scope":
              calls flow "rag_engine.remove_document_selection"
            action "Queue re-index":
              calls flow "rag_engine.ingest_document"
            action "Remove source":
              calls flow "rag_engine.remove_document"
              interaction is confirm_destructive
          empty_state: hidden

page "Tuning":
  debug_only: true
  layout:
    header:
      title is "Tuning"
      text is "Tune retrieval blending without introducing non-determinism."
      row:
        column:
          section "Status":
            list is rag_engine.Notice:
              variant is "single_line"
              item:
                primary is message
              empty_state: hidden

    main:
      section "Retrieval Controls":
        text is "Adjust semantic_weight, semantic_k, lexical_k, final_top_k, and filter tags."
        row:
          column:
            button "Apply lexical preset":
              variant is "secondary"
              calls flow "rag_engine.apply_retrieval_weight_preset_lexical"
          column:
            button "Apply balanced preset":
              variant is "secondary"
              calls flow "rag_engine.apply_retrieval_weight_preset_balanced"
          column:
            button "Apply semantic preset":
              variant is "secondary"
              calls flow "rag_engine.apply_retrieval_weight_preset_semantic"

        row:
          column:
            button "Reset Semantic K to 4":
              variant is "secondary"
              calls flow "rag_engine.set_semantic_k_4"
          column:
            button "Reset Semantic K to 8":
              variant is "secondary"
              calls flow "rag_engine.set_semantic_k_8"
          column:
            button "Reset Semantic K to 12":
              variant is "secondary"
              calls flow "rag_engine.set_semantic_k_12"

        row:
          column:
            button "Reset Lexical K to 4":
              variant is "secondary"
              calls flow "rag_engine.set_lexical_k_4"
          column:
            button "Reset Lexical K to 8":
              variant is "secondary"
              calls flow "rag_engine.set_lexical_k_8"
          column:
            button "Reset Lexical K to 12":
              variant is "secondary"
              calls flow "rag_engine.set_lexical_k_12"

        row:
          column:
            button "Reset Final Top K to 3":
              variant is "secondary"
              calls flow "rag_engine.set_final_top_k_3"
          column:
            button "Reset Final Top K to 5":
              variant is "secondary"
              calls flow "rag_engine.set_final_top_k_5"
          column:
            button "Reset Final Top K to 8":
              variant is "secondary"
              calls flow "rag_engine.set_final_top_k_8"

        row:
          column:
            button "Filter tags to all":
              variant is "secondary"
              calls flow "rag_engine.filter_tags_all"
          column:
            button "Filter tags to product":
              variant is "secondary"
              calls flow "rag_engine.filter_tags_product"
          column:
            button "Filter tags to policy":
              variant is "secondary"
              calls flow "rag_engine.filter_tags_policy"

page "Explain":
  debug_only: true
  layout:
    header:
      title is "Explain"
      text is "See exactly why retrieval selected each source."
      row:
        column:
          section "Status":
            list is rag_engine.Notice:
              variant is "single_line"
              item:
                primary is message
              empty_state: hidden
        column:
          section "Trust":
            trust_indicator from is state.answer.trusted

    main:
      section "Answer Rationale":
        list is rag_engine.ExplainSummary:
          variant is "two_line"
          item:
            primary is retrieval_mode
            secondary is citation_summary
            meta is retrieval_params
          empty_state: hidden

      section "Citations":
        list is rag_engine.CitationCard:
          variant is "two_line"
          item:
            primary is source_name
            secondary is page_label
            meta is snippet
          actions:
            action "Open in source drawer":
              calls flow "rag_engine.open_citation"
            action "Rename file":
              calls flow "rag_engine.rename_document"
              interaction is rename_modal
            action "Move to project...":
              calls flow "rag_engine.move_document_to_project"
              interaction is project_picker
            action "Delete file":
              calls flow "rag_engine.remove_document"
              interaction is confirm_destructive
          empty_state: hidden
        source_preview from is state.ui.preview_source

      section "Diagnostics Mode":
        row:
          column:
            button "View semantic candidates":
              variant is "secondary"
              calls flow "rag_engine.set_diagnostics_mode_semantic"
          column:
            button "View lexical candidates":
              variant is "secondary"
              calls flow "rag_engine.set_diagnostics_mode_lexical"
          column:
            button "View final ranking":
              variant is "secondary"
              calls flow "rag_engine.set_diagnostics_mode_final"

        row:
          column:
            button "View Diagnostics":
              variant is "secondary"
              calls flow "rag_engine.refresh_diagnostics_view"

      table is rag_engine.RetrievalCandidateView:
        columns:
          include display_rank
          include source_name
          include tag
          include tier
          include lexical_hits
          include merged_score
          include selected
          include reason
        sort:
          by is display_rank
          order is asc
        empty_state: hidden

      table is rag_engine.ExplainCandidate:
        columns:
          include order
          include decision
          include reason
          include page_number
          include chunk_index
          include ingestion_phase
          include keyword_overlap
        sort:
          by is order
          order is asc
        empty_state: hidden
