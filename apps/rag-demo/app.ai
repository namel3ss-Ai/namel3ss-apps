spec is "1.0"

capabilities:
  uploads
  ui.theming
  streaming
  ui_navigation

ui:
  theme is "modern"
  accent color is "cyan"
  density is "comfortable"
  motion is "subtle"
  shape is "rounded"
  surface is "flat"
  primary color is "#95A3C6"
  secondary color is "#6E7997"
  background color is "#2D3041"
  foreground color is "#E8EAF2"
  font family is "SF Pro Display"
  spacing scale is 1.0
  border radius is 10
  shadow level is 1

policy
  allow ingestion.run
  allow ingestion.review
  allow ingestion.override
  allow retrieval.include_warn

use "rag_engine" as rag_engine

contract flow "rag_engine.initialize_defaults":
  input:
  output:
    status is text

contract flow "rag_engine.seed_examples":
  input:
  output:
    status is text

contract flow "rag_engine.refresh_index_summary":
  input:
  output:
    status is text

contract flow "rag_engine.seed_sample_corpus":
  input:
  output:
    status is text

contract flow "rag_engine.sync_library":
  input:
  output:
    status is text

contract flow "rag_engine.ingest_selected":
  input:
  output:
    status is text

contract flow "rag_engine.rerun_last_query":
  input:
  output:
    status is text

contract flow "rag_engine.refresh_diagnostics_view":
  input:
  output:
    status is text

contract flow "rag_engine.set_semantic_k":
  input:
    value is number
  output:
    status is text

contract flow "rag_engine.set_lexical_k":
  input:
    value is number
  output:
    status is text

contract flow "rag_engine.set_final_top_k":
  input:
    value is number
  output:
    status is text

contract flow "rag_engine.finalize_answer_state":
  input:
  output:
    status is text

contract flow "rag_engine.ask_question":
  input:
    message is text
  output:
    answer_text is text
    mode is text

nav_sidebar:
  item "New Chat" goes_to "Chat"
  item "Documents" goes_to "Library"
  item "Tuning" goes_to "Tuning"
  item "Explain" goes_to "Explain"

page "Chat":
  layout:
    header:
      title is "Namel3ss RAG"
      text is "Select a model and ask grounded questions with source-backed answers."
      row:
        column:
          section "Model":
            text is "rag_engine default retrieval profile"
        column:
          section "Status":
            list is rag_engine.Notice:
              variant is "single_line"
              item:
                primary is message
              empty_state: hidden
        column:
          section "Trust":
            trust_indicator from is state.answer.trusted

    main:
      section "How can I help you today?":
        row:
          column:
            section "Tell me what this file is about":
              text is "Summarize only from indexed evidence and show citations."
          column:
            section "Show me strongest evidence":
              text is "Prioritize chunks with highest grounding confidence."
        row:
          column:
            section "Compare two concepts":
              text is "Explain differences and cite each claim."
          column:
            section "Extract policies and rules":
              text is "Return constraints with source snippets."

      section "Conversation":
        chat:
          style is "bubbles"
          show_avatars is false
          group_messages is true
          actions are ["view_sources"]
          attachments are true
          streaming is false
          messages from is state.chat.messages
          thinking when is state.loading
          composer calls flow "rag_engine.ask_question"

      row:
        column:
          button "Reset chat":
            variant is "secondary"
            calls flow "rag_engine.reset_chat"
        column:
          button "Reset source drawer":
            variant is "secondary"
            calls flow "rag_engine.clear_sources_drawer"

    drawer_right:
      section "Sources":
        text is "Open and inspect source snippets selected for the current answer."
        list is rag_engine.CitationCard:
          variant is "two_line"
          item:
            primary is source_name
            secondary is page_label
            meta is snippet
          actions:
            action "Open in source drawer":
              calls flow "rag_engine.open_citation"
          empty_state: hidden

page "Library":
  layout:
    header:
      title is "Documents"
      text is "Upload content, run deterministic ingestion, and choose scope."
      row:
        column:
          section "Status":
            list is rag_engine.Notice:
              variant is "single_line"
              item:
                primary is message
              empty_state: hidden

    main:
      section "Upload and Index":
        text is "Supported types: application/pdf and text/plain."
        text is "Ingestion states: queued -> ingesting -> ready."
        upload documents:
          accept is "application/pdf,text/plain"
          multiple is true
          required is false
          label is "Upload documents"
          preview is false

        row:
          column:
            button "Refresh uploads":
              variant is "secondary"
              calls flow "rag_engine.sync_library"
          column:
            button "Build index":
              variant is "primary"
              calls flow "rag_engine.ingest_selected"

        row:
          column:
            button "Run guided path":
              variant is "secondary"
              calls flow "rag_engine.run_demo_mode_path"
          column:
            button "Create sample corpus":
              variant is "secondary"
              calls flow "rag_engine.seed_sample_corpus"

      section "Index Summary":
        table is rag_engine.IndexSummary:
          columns:
            include total_documents
            include ready_documents
            include queued_documents
            include ingesting_documents
            include failed_documents
            include chunk_count
            include tag_product_count
            include tag_policy_count
          empty_state: hidden

      section "Scope":
        text is "Select which sources and tags are active during retrieval."
        scope_selector from is state.tag.options active in state.tag.active

        row:
          column:
            button "Select all sources":
              variant is "secondary"
              calls flow "rag_engine.bulk_select_all"
          column:
            button "Clear selected sources":
              variant is "secondary"
              calls flow "rag_engine.bulk_clear_selection"

        row:
          column:
            button "Re-index selected sources":
              variant is "secondary"
              calls flow "rag_engine.bulk_reindex_selected"
          column:
            button "Remove selected sources":
              variant is "secondary"
              calls flow "rag_engine.bulk_remove_selected"

        row:
          column:
            button "Tag selected as Product":
              variant is "secondary"
              calls flow "rag_engine.bulk_tag_selected_product"
          column:
            button "Tag selected as Policy":
              variant is "secondary"
              calls flow "rag_engine.bulk_tag_selected_policy"

        list is rag_engine.DocumentLibrary:
          variant is "two_line"
          selection is "multi"
          item:
            primary is source_name
            secondary is status_label
            meta is scope_label
          actions:
            action "Add to scope":
              calls flow "rag_engine.add_document_selection"
            action "Remove from scope":
              calls flow "rag_engine.remove_document_selection"
            action "Queue re-index":
              calls flow "rag_engine.ingest_document"
            action "Remove source":
              calls flow "rag_engine.remove_document"
          empty_state: hidden

page "Tuning":
  layout:
    header:
      title is "Tuning"
      text is "Tune retrieval blending without introducing non-determinism."
      row:
        column:
          section "Status":
            list is rag_engine.Notice:
              variant is "single_line"
              item:
                primary is message
              empty_state: hidden

    main:
      section "Retrieval Controls":
        text is "Adjust semantic_weight, semantic_k, lexical_k, final_top_k, and filter tags."
        row:
          column:
            button "Apply lexical preset":
              variant is "secondary"
              calls flow "rag_engine.apply_retrieval_weight_preset_lexical"
          column:
            button "Apply balanced preset":
              variant is "secondary"
              calls flow "rag_engine.apply_retrieval_weight_preset_balanced"
          column:
            button "Apply semantic preset":
              variant is "secondary"
              calls flow "rag_engine.apply_retrieval_weight_preset_semantic"

        row:
          column:
            button "Set semantic_k to 4":
              variant is "secondary"
              calls flow "rag_engine.set_semantic_k_4"
          column:
            button "Set semantic_k to 8":
              variant is "secondary"
              calls flow "rag_engine.set_semantic_k_8"
          column:
            button "Set semantic_k to 12":
              variant is "secondary"
              calls flow "rag_engine.set_semantic_k_12"

        row:
          column:
            button "Set lexical_k to 4":
              variant is "secondary"
              calls flow "rag_engine.set_lexical_k_4"
          column:
            button "Set lexical_k to 8":
              variant is "secondary"
              calls flow "rag_engine.set_lexical_k_8"
          column:
            button "Set lexical_k to 12":
              variant is "secondary"
              calls flow "rag_engine.set_lexical_k_12"

        row:
          column:
            button "Set final_top_k to 3":
              variant is "secondary"
              calls flow "rag_engine.set_final_top_k_3"
          column:
            button "Set final_top_k to 5":
              variant is "secondary"
              calls flow "rag_engine.set_final_top_k_5"
          column:
            button "Set final_top_k to 8":
              variant is "secondary"
              calls flow "rag_engine.set_final_top_k_8"

        row:
          column:
            button "Filter tags to all":
              variant is "secondary"
              calls flow "rag_engine.filter_tags_all"
          column:
            button "Filter tags to product":
              variant is "secondary"
              calls flow "rag_engine.filter_tags_product"
          column:
            button "Filter tags to policy":
              variant is "secondary"
              calls flow "rag_engine.filter_tags_policy"

page "Explain":
  layout:
    header:
      title is "Explain"
      text is "See exactly why retrieval selected each source."
      row:
        column:
          section "Status":
            list is rag_engine.Notice:
              variant is "single_line"
              item:
                primary is message
              empty_state: hidden
        column:
          section "Trust":
            trust_indicator from is state.answer.trusted

    main:
      section "Answer Rationale":
        list is rag_engine.ExplainSummary:
          variant is "two_line"
          item:
            primary is retrieval_mode
            secondary is citation_summary
            meta is retrieval_params
          empty_state: hidden

      section "Citations":
        list is rag_engine.CitationCard:
          variant is "two_line"
          item:
            primary is source_name
            secondary is page_label
            meta is snippet
          actions:
            action "Open in source drawer":
              calls flow "rag_engine.open_citation"
          empty_state: hidden

      section "Diagnostics Mode":
        row:
          column:
            button "View semantic candidates":
              variant is "secondary"
              calls flow "rag_engine.set_diagnostics_mode_semantic"
          column:
            button "View lexical candidates":
              variant is "secondary"
              calls flow "rag_engine.set_diagnostics_mode_lexical"
          column:
            button "View final ranking":
              variant is "secondary"
              calls flow "rag_engine.set_diagnostics_mode_final"

        row:
          column:
            button "Refresh diagnostics":
              variant is "secondary"
              calls flow "rag_engine.refresh_diagnostics_view"

      table is rag_engine.RetrievalCandidateView:
        columns:
          include display_rank
          include source_name
          include tag
          include tier
          include lexical_hits
          include merged_score
          include selected
          include reason
        sort:
          by is display_rank
          order is asc
        empty_state: hidden

      table is rag_engine.ExplainCandidate:
        columns:
          include order
          include decision
          include reason
          include page_number
          include chunk_index
          include ingestion_phase
          include keyword_overlap
        sort:
          by is order
          order is asc
        empty_state: hidden
